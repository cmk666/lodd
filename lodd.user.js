// ==UserScript==
// @name         Luogu Original Difficulty Display
// @version      4.5
// @description  Luogu original difficulty display
// @author       cmk666
// @match        https://www.luogu.com.cn/*
// @connect      codeforces.com
// @connect      kenkoooo.com
// @icon         https://www.google.com/s2/favicons?sz=64&domain=luogu.com.cn
// @grant        GM_xmlhttpRequest
// ==/UserScript==
(()=>{"use strict";const t="#app>div.main-container.lside-bar>main>div>div>div.side>div:nth-child(1)>div:nth-child(1)>span:nth-child(1)",l="#app>div.main-container.lside-bar>main>div>div>div.side>div:nth-child(1)>div:nth-child(4)>span:nth-child(1)",n="#app>div.main-container.lside-bar>main>div>div>div.side>div:nth-child(1)>div:nth-child(5)>span:nth-child(1)",r="原始难度",i="获取中",a="暂无难度",c="获取失败";var s,f,h;const u=()=>{void 0!==s&&void 0!==f&&void 0!==h&&(h.innerText=s,""!==f)&&h.classList.add(f)},g=e=>e<1200?"lodd-cf-gray":e<1400?"lodd-cf-green":e<1600?"lodd-cf-cyan":e<1900?"lodd-cf-blue":e<2100?"lodd-cf-purple":e<2400?"lodd-cf-orange":e<3e3?"lodd-cf-red":"lodd-cf-blackred",p=e=>e<400?"lodd-at-gray":e<800?"lodd-at-brown":e<1200?"lodd-at-green":e<1600?"lodd-at-aqua":e<2e3?"lodd-at-blue":e<2400?"lodd-at-yellow":e<2800?"lodd-at-orange":"lodd-at-red",v=(e,o)=>{o.parentNode.lastChild==o?o.parentNode.appendChild(e):o.parentNode.insertBefore(e,o.nextSibling)},b=e=>{return!!/^\/problem\/\w+/.test(e)&&(e=e.substr(9),/^CF\d+[A-Z]\d*(#\w+)?$/.test(e)||/^AT_\w+(#\w+)?$/.test(e))},w=e=>{if(s=f=void 0,b(e)){var o,e=e.substr(9);if(null!==(o=/^CF(\d+)([A-Z]\d*)(#\w+)?$/.exec(e))){const d=o[1],t=o[2];GM_xmlhttpRequest({method:"GET",url:"https://codeforces.com/api/contest.standings?from=1&count=1&contestId="+d,onload:e=>{try{var o=JSON.parse(e.responseText);if("OK"!==o.status);else for(var d of o.result.problems)if(d.index===t)return f=void 0===d.rating?(s=a,""):(s=d.rating,g(d.rating)),void u();s=c,f="",u()}catch{s=c,f="",u()}},onerror:()=>{s=c,f="",u()}})}else if(null!==(o=/^AT_(\w+)(#\w+)?$/.exec(e))){const l=o[1];GM_xmlhttpRequest({method:"GET",url:"https://kenkoooo.com/atcoder/resources/problem-models.json",onload:e=>{try{var o=JSON.parse(e.responseText)[l];void 0!==o?(f=void 0===o.difficulty?(s=a,""):((s=o.difficulty)<400&&(s=Math.round(400/Math.exp(1-s/400))),p(o.difficulty)),u()):(s=c,f="",u())}catch{s=c,f="",u()}},onerror:()=>{s=c,f="",u()}})}}},d=e=>{var o=document.createElement("style"),o=(o.innerText=".lodd-cf-gray{font-weight:bold;color:gray;}.lodd-cf-green{font-weight:bold;color:green;}.lodd-cf-cyan{font-weight:bold;color:#03a89e;}.lodd-cf-blue{font-weight:bold;color:blue;}.lodd-cf-purple{font-weight:bold;color:#a0a;}.lodd-cf-orange{font-weight:bold;color:#ff8c00;}.lodd-cf-red,.lodd-cf-blackred{font-weight:bold;color:red;}.lodd-cf-blackred:first-letter{font-weight:bold;color:black;}.lodd-at-gray{font-weight:bold;color:gray;}.lodd-at-brown{font-weight:bold;color:#804000;}.lodd-at-green{font-weight:bold;color:green;}.lodd-at-aqua{font-weight:bold;color:#00c0c0;}.lodd-at-blue{font-weight:bold;color:blue;}.lodd-at-yellow{font-weight:bold;color:#c0c000;}.lodd-at-orange{font-weight:bold;color:#ff8000;}.lodd-at-red{font-weight:bold;color:red;}",document.head.appendChild(o),w(e),e);if(h=void 0,b(o)){const d=setInterval(()=>{var e,o;void 0!==h||null!==(o=document.querySelector(n))&&o.innerText===r||(o=document.querySelector(t),e=document.querySelector(l),null!=o&&null!=e&&((o=o.parentNode.cloneNode(!0)).children[0].innerHTML=r,(h=o.children[1]).innerText=i,v(o,e.parentNode),u(),clearInterval(d)))},100)}};let m=unsafeWindow.console.info;Object.defineProperty(unsafeWindow.console,"info",{set:e=>{console.warn("Some script is trying to modify `unsafeWindow.console.info`. Maybe SB exlg?"),m=e},get:()=>(...e)=>{var o;"[@lfe/loader]"===e[0]&&"Navigated"===e[1]&&(null!==(o=document.querySelector(n))&&o.innerText===r&&(o=o.parentNode.parentNode).parentNode.removeChild(o),d(e[2])),m(...e)}}),addEventListener("ononline",w),d(location.pathname)})();